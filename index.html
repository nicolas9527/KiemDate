<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>

  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="KI·ªÇM DATE" />
  <link rel="apple-touch-icon" href="icon.png.PNG" />
  <link rel="icon" type="image/png" href="icon.png.PNG" />

  <title>KI·ªÇM DATE</title>

  <style>
    :root {
      --primary:#1976d2; --secondary:#64b5f6; --bg:#f0f4f8; --card:#ffffff;
      --danger:#d32f2f; --warn:#ef6c00; --ok:#1b5e20;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:-apple-system, system-ui, sans-serif;
      background:var(--bg);
      padding:12px;
      color:#333;
      -webkit-font-smoothing:antialiased;
    }
    .app{ max-width:520px; margin:0 auto; }

    h1{
      text-align:center;
      color:var(--primary);
      font-size:22px;
      margin:10px 0 12px;
      font-weight:900;
      letter-spacing:0.2px;
    }

    .input-box{
      background:var(--card);
      border-radius:24px;
      padding:18px;
      box-shadow:0 4px 20px rgba(0,0,0,0.05);
      margin-bottom:12px;
    }

    .input-group{ margin-bottom:14px; width:100%; position:relative; }
    label{
      color:var(--primary);
      font-weight:800;
      font-size:13px;
      display:block;
      margin:0 0 6px 8px;
    }

    input[type="text"], input[type="tel"], input[type="number"], input[type="date"]{
      width:100%;
      height:50px;
      border-radius:15px;
      border:1.5px solid #e1e8ed;
      padding:0 14px;
      font-size:16px;
      outline:none;
      background:#f9fbff;
      text-align:center;
      display:block;
    }
    input:focus{ border-color:var(--secondary); background:#fff; }
    input:focus::placeholder{ color:transparent; }

    /* ‚úÖ FIX iOS: cƒÉn gi·ªØa ch·ªØ trong input date (HSD) */
    input[type="date"]{
      height:50px;
      line-height:50px;
      padding:0 14px;
      display:flex;
      align-items:center;
      justify-content:center;
      -webkit-appearance:none;
      appearance:none;
      min-height:50px;
    }
    input[type="date"]::-webkit-date-and-time-value{
      height:50px;
      line-height:50px;
      text-align:center;
      margin:0;
      padding:0;
      /* transform: translateY(1px); */
    }
    input[type="date"]::-webkit-calendar-picker-indicator{
      margin:0;
      padding:0;
    }

    .suggestions{
      position:absolute;
      top:76px;
      left:0;
      right:0;
      background:#fff;
      border-radius:15px;
      box-shadow:0 8px 25px rgba(0,0,0,0.15);
      z-index:100;
      max-height:220px;
      overflow:auto;
      display:none;
      border:1px solid #eee;
    }
    .sug-item{
      padding:12px 14px;
      border-bottom:1px solid #f3f4f6;
      font-size:14px;
      color:#333;
      text-align:left;
      cursor:pointer;
    }
    .sug-item b{ display:block; font-size:14px; }
    .sug-item small{ color:#6b7280; font-weight:700; display:block; margin-top:2px; }

    .btn-row{ display:flex; gap:10px; margin-top:2px; }
    .btn{
      flex:1;
      height:50px;
      border:none;
      border-radius:15px;
      font-weight:900;
      font-size:15px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      color:#fff;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
    }
    .btn:active{ transform:scale(0.99); }
    .btn-paste{ background:var(--secondary); }
    .btn-save{ background:var(--primary); }
    .btn-cancel{ background:#94a3b8; }
    .btn-danger{ background:var(--danger); }

    .summary{ display:flex; gap:8px; margin:10px 0 12px; }
    .chip{
      flex:1;
      background:#fff;
      border:1px solid #eef2f7;
      border-radius:14px;
      padding:10px;
      text-align:center;
      box-shadow:0 2px 10px rgba(0,0,0,0.03);
    }
    .chip .n{ font-weight:1000; font-size:18px; line-height:1.2; }
    .chip .t{ font-size:11px; color:#6b7280; font-weight:800; margin-top:2px; }

    .data-manager{
      background:rgba(255,255,255,0.55);
      border-radius:20px;
      padding:12px;
      margin-bottom:12px;
      border:1px solid rgba(25,118,210,0.1);
    }
    .manager-row{ display:flex; gap:8px; margin-bottom:10px; flex-wrap:wrap; }
    .tool-btn{
      flex:1;
      min-width:120px;
      height:42px;
      background:#fff;
      border:1.5px solid var(--primary);
      color:var(--primary);
      border-radius:12px;
      font-size:13px;
      font-weight:900;
      cursor:pointer;
    }
    .tool-btn.primary{ background:var(--primary); color:#fff; }
    .tool-btn.danger{ border-color:var(--danger); color:var(--danger); }

    .search-bar{
      width:100%;
      height:46px;
      border-radius:23px;
      border:1.5px solid #d1d9e0;
      padding:0 15px;
      background:#fff;
      font-size:15px;
      text-align:center;
      outline:none;
    }

    /* ===== LIST CARD ===== */
    .item{
      background:#fff;
      border-radius:20px;
      padding:16px;
      padding-right:96px; /* ‚úÖ ch·ª´a ch·ªó cho c·ª•m n√∫t b√™n ph·∫£i (xo√° tr√™n + 2 n√∫t d∆∞·ªõi ngang) */
      margin-bottom:12px;
      position:relative;
      border-left:6px solid #d1d9e0;
      box-shadow:0 2px 12px rgba(0,0,0,0.04);
      overflow:hidden;
    }
    .c-red{ border-left-color:var(--danger); background:#fffbfb; }
    .c-orange{ border-left-color:#ff9800; background:#fffaf2; }

    .p-name{
      font-weight:1000;
      color:#0d47a1;
      font-size:16px;
      margin-bottom:6px;
      text-transform:uppercase;
      word-break:break-word;
    }
    .p-sku{
      font-size:11px;
      background:#e3f2fd;
      padding:3px 8px;
      border-radius:6px;
      color:#1565c0;
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      display:inline-block;
      margin-bottom:6px;
      max-width:100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .meta{ font-size:13px; color:#555; margin-top:2px; }
    .t-status{ font-size:14px; font-weight:1000; margin-top:8px; }
    .t-red{ color:var(--danger); }
    .t-orange{ color:var(--warn); }
    .t-ok{ color:var(--ok); }

    /* ‚úÖ Actions: Xo√° ·ªü g√≥c ph·∫£i tr√™n */
    .action-top{
      position:absolute;
      top:12px;
      right:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:center;
      width:56px;
      z-index:2;
    }

    /* ‚úÖ Actions: S·ª≠a (tr√°i) + Copy (ph·∫£i) n·∫±m ngang ·ªü g√≥c ph·∫£i d∆∞·ªõi */
    .action-bottom{
      position:absolute;
      right:10px;
      bottom:12px;
      display:flex;
      flex-direction:row;    /* ‚úÖ n·∫±m ngang */
      gap:8px;
      align-items:center;
      justify-content:flex-end;
      width:auto;            /* ‚úÖ kh√¥ng √©p 56px */
      z-index:2;
    }

    .icon-btn{
      width:38px;
      height:38px;
      border-radius:12px;
      background:#eef6ff;
      border:1px solid #cfe6ff;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
      font-size:17px;
      box-shadow:0 2px 8px rgba(0,0,0,0.06);
    }
    .icon-btn:active{ transform:scale(0.98); }
    .icon-btn.danger{ background:#fff0f0; border-color:#ffd0d0; }

    @media (max-width: 380px){
      .item{ padding-right:90px; }
      .action-top{ right:8px; width:52px; gap:7px; }
      .action-bottom{ right:8px; gap:7px; }
      .icon-btn{ width:36px; height:36px; font-size:16px; }
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:rgba(17,24,39,0.92);
      color:#fff;
      padding:10px 14px;
      border-radius:14px;
      font-weight:900;
      font-size:13px;
      display:none;
      z-index:999;
      max-width:92%;
      text-align:center;
      box-shadow:0 10px 30px rgba(0,0,0,0.25);
    }

    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.35);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:1000;
      padding:14px;
    }
    .modal{
      width:100%;
      max-width:520px;
      background:#fff;
      border-radius:18px;
      padding:14px;
      box-shadow:0 20px 50px rgba(0,0,0,0.25);
    }
    .modal h2{ margin:6px 4px 8px; font-size:16px; color:#0f172a; font-weight:1000; }
    .modal p{ margin:0 4px 12px; color:#6b7280; font-size:13px; font-weight:800; }
    .modal .btn-row{ margin-top:10px; }
  </style>
</head>

<body>
  <div class="app">
    <h1>üìÖ KI·ªÇM DATE</h1>

    <div class="input-box">
      <div class="input-group">
        <label>M√£ SKU / Barcode</label>

        <input id="sku"
               type="tel"
               inputmode="numeric"
               pattern="[0-9]*"
               placeholder="Nh·∫≠p ho·∫∑c qu√©t m√£..."
               autocomplete="off" />

        <div id="suggestions" class="suggestions"></div>
      </div>

      <div class="input-group">
        <label>T√™n s·∫£n ph·∫©m</label>
        <input id="name" type="text" placeholder="T√™n s·∫£n ph·∫©m..." autocomplete="off" />
      </div>

      <div class="input-group">
        <label>H·∫°n s·ª≠ d·ª•ng (HSD)</label>
        <input id="hsd" type="date" />
      </div>

      <div class="btn-row">
        <button id="btnPaste" class="btn btn-paste" type="button">üìã D√°n m√£</button>
        <button id="btnSave" class="btn btn-save" type="button">üíæ L∆∞u l·∫°i</button>
      </div>

      <div id="editRow" class="btn-row" style="display:none; margin-top:10px;">
        <button id="btnCancelEdit" class="btn btn-cancel" type="button">‚Ü©Ô∏è Hu·ª∑ s·ª≠a</button>
        <button id="btnDeleteEdit" class="btn btn-danger" type="button">üóëÔ∏è Xo√° d√≤ng</button>
      </div>
    </div>

    <div class="summary">
      <div class="chip"><div id="sumTotal" class="n">0</div><div class="t">T·ªïng</div></div>
      <div class="chip"><div id="sumExpired" class="n">0</div><div class="t">H·∫øt h·∫°n</div></div>
      <div class="chip"><div id="sum7" class="n">0</div><div class="t">‚â§ 7 ng√†y</div></div>
      <div class="chip"><div id="sum30" class="n">0</div><div class="t">‚â§ 30 ng√†y</div></div>
    </div>

    <div class="data-manager">
      <div class="manager-row">
        <input type="file" id="csvIn" hidden accept=".csv,text/csv" />
        <button id="btnImport" class="tool-btn" type="button">üì• NH·∫¨P CSV</button>
        <button id="btnExport" class="tool-btn primary" type="button">üì§ XU·∫§T CSV</button>
        <button id="btnClearAll" class="tool-btn danger" type="button">üßπ XO√Å ALL</button>
      </div>
      <input id="search" class="search-bar" type="text" placeholder="T√¨m t√™n / SKU / HSD..." />
    </div>

    <div id="list"></div>
  </div>

  <div id="toast" class="toast"></div>

  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <h2 id="modalTitle">X√°c nh·∫≠n</h2>
      <p id="modalText">B·∫°n ch·∫Øc ch·ª©?</p>
      <div class="btn-row">
        <button id="modalCancel" class="btn btn-cancel" type="button">Hu·ª∑</button>
        <button id="modalOk" class="btn btn-danger" type="button">ƒê·ªìng √Ω</button>
      </div>
    </div>
  </div>

<script>
(() => {
  // ========= DOM =========
  const skuI = document.getElementById('sku');
  const nameI = document.getElementById('name');
  const hsdI = document.getElementById('hsd');
  const sugD = document.getElementById('suggestions');
  const listEl = document.getElementById('list');
  const searchI = document.getElementById('search');

  const btnPaste = document.getElementById('btnPaste');
  const btnSave = document.getElementById('btnSave');
  const editRow = document.getElementById('editRow');
  const btnCancelEdit = document.getElementById('btnCancelEdit');
  const btnDeleteEdit = document.getElementById('btnDeleteEdit');

  const btnImport = document.getElementById('btnImport');
  const btnExport = document.getElementById('btnExport');
  const btnClearAll = document.getElementById('btnClearAll');
  const csvIn = document.getElementById('csvIn');

  const sumTotal = document.getElementById('sumTotal');
  const sumExpired = document.getElementById('sumExpired');
  const sum7 = document.getElementById('sum7');
  const sum30 = document.getElementById('sum30');

  const toastEl = document.getElementById('toast');
  const modalBackdrop = document.getElementById('modalBackdrop');
  const modalTitle = document.getElementById('modalTitle');
  const modalText = document.getElementById('modalText');
  const modalCancel = document.getElementById('modalCancel');
  const modalOk = document.getElementById('modalOk');

  // ========= Storage keys =========
  const KEY_V2 = 'kiemdate_v2';
  const KEY_V2_MAP = 'kiemdate_v2_skuMap';

  // ========= State =========
  let data = [];     // {id, sku, name, hsd, createdAt}
  let skuMap = {};   // {sku: name}
  let editingId = null;

  // ========= Utils =========
  const now = () => Date.now();
  function uid() {
    if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
    return 'id_' + Math.random().toString(16).slice(2) + '_' + Date.now().toString(16);
  }
  const trim = (s) => (s ?? '').toString().trim();

  function showToast(msg, ms=1500){
    toastEl.textContent = msg;
    toastEl.style.display = 'block';
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=> toastEl.style.display='none', ms);
  }

  function openConfirm({title='X√°c nh·∫≠n', text='B·∫°n ch·∫Øc ch·ª©?', okText='ƒê·ªìng √Ω', cancelText='Hu·ª∑'}){
    return new Promise(resolve => {
      modalTitle.textContent = title;
      modalText.textContent = text;
      modalOk.textContent = okText;
      modalCancel.textContent = cancelText;
      modalBackdrop.style.display = 'flex';

      const cleanup = () => {
        modalBackdrop.style.display = 'none';
        modalCancel.removeEventListener('click', onCancel);
        modalOk.removeEventListener('click', onOk);
        modalBackdrop.removeEventListener('click', onBackdrop);
      };
      const onCancel = () => { cleanup(); resolve(false); };
      const onOk = () => { cleanup(); resolve(true); };
      const onBackdrop = (e) => { if(e.target === modalBackdrop){ cleanup(); resolve(false); } };

      modalCancel.addEventListener('click', onCancel);
      modalOk.addEventListener('click', onOk);
      modalBackdrop.addEventListener('click', onBackdrop);
    });
  }

  function storageAvailable(){
    try{
      const k='__test__'+Math.random();
      localStorage.setItem(k,'1');
      localStorage.removeItem(k);
      return true;
    }catch{ return false; }
  }

  function normalizeDateToISO(v){
    v = trim(v);
    if(!v) return '';
    if(/^\d{4}-\d{2}-\d{2}$/.test(v)) return v;

    let m = v.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
    if(m){
      const dd=String(m[1]).padStart(2,'0');
      const mm=String(m[2]).padStart(2,'0');
      const yy=m[3];
      return `${yy}-${mm}-${dd}`;
    }

    m = v.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
    if(m){
      const yy=m[1];
      const mm=String(m[2]).padStart(2,'0');
      const dd=String(m[3]).padStart(2,'0');
      return `${yy}-${mm}-${dd}`;
    }

    const d = new Date(v);
    if(!isNaN(d.getTime())){
      const yy=d.getFullYear();
      const mm=String(d.getMonth()+1).padStart(2,'0');
      const dd=String(d.getDate()).padStart(2,'0');
      return `${yy}-${mm}-${dd}`;
    }
    return '';
  }

  function validISODate(iso){
    if(!/^\d{4}-\d{2}-\d{2}$/.test(iso)) return false;
    const d = new Date(iso + 'T12:00:00');
    if(isNaN(d.getTime())) return false;
    const [y,m,dd] = iso.split('-').map(Number);
    return d.getFullYear()===y && (d.getMonth()+1)===m && d.getDate()===dd;
  }

  function fmtDMY(iso){
    if(!iso || !/^\d{4}-\d{2}-\d{2}$/.test(iso)) return iso || '';
    const [y,m,d] = iso.split('-');
    return `${d}/${m}/${y}`;
  }

  function daysLeft(iso){
    const target = new Date(iso + 'T23:59:59');
    return Math.ceil((target.getTime() - now()) / 86400000);
  }

  function statusFor(d){
    if(d < 0) return { cls:'c-red', text:'‚ùå ƒê√É H·∫æT H·∫†N', tcls:'t-red' };
    if(d === 0) return { cls:'c-red', text:'üî• H·∫øt h·∫°n h√¥m nay', tcls:'t-red' };
    if(d <= 7) return { cls:'c-red', text:`‚ö†Ô∏è S·∫Øp h·∫øt h·∫°n (${d} ng√†y)`, tcls:'t-red' };
    if(d <= 30) return { cls:'c-orange', text:`‚è∞ C·∫≠n date (${d} ng√†y)`, tcls:'t-orange' };
    return { cls:'', text:`‚úÖ C√≤n ${d} ng√†y`, tcls:'t-ok' };
  }

  function saveStorage(){
    try{
      localStorage.setItem(KEY_V2, JSON.stringify(data));
      localStorage.setItem(KEY_V2_MAP, JSON.stringify(skuMap));
      return true;
    }catch(e){
      showToast('‚ùå Kh√¥ng l∆∞u ƒë∆∞·ª£c (localStorage b·ªã ch·∫∑n)');
      return false;
    }
  }

  function loadStorage(){
    const v2 = localStorage.getItem(KEY_V2);
    const v2m = localStorage.getItem(KEY_V2_MAP);

    if(v2){
      try { data = JSON.parse(v2) || []; } catch { data = []; }
      try { skuMap = JSON.parse(v2m || '{}') || {}; } catch { skuMap = {}; }
      if(!Array.isArray(data)) data = [];
      return;
    }

    const oldDates = localStorage.getItem('dates');
    const oldMap = localStorage.getItem('skuMap');

    if(oldDates || oldMap){
      let od=[], om={};
      try { od = JSON.parse(oldDates || '[]') || []; } catch { od=[]; }
      try { om = JSON.parse(oldMap || '{}') || {}; } catch { om={}; }

      skuMap = (om && typeof om === 'object') ? om : {};
      data = [];

      (Array.isArray(od)?od:[]).forEach(item => {
        const s = trim(item?.sku);
        const h = normalizeDateToISO(item?.hsd);
        const n = trim(item?.name) || skuMap[s] || 'S·∫£n ph·∫©m m·ªõi';
        if(s && validISODate(h)){
          data.push({ id: uid(), sku:s, name:n, hsd:h, createdAt: now() });
          if(!skuMap[s]) skuMap[s]=n;
        }
      });

      saveStorage();
      showToast('‚úÖ ƒê√£ n√¢ng c·∫•p d·ªØ li·ªáu');
      return;
    }

    data = [];
    skuMap = {};
  }

  // ========= Suggestions =========
  function hideSuggestions(){ sugD.style.display='none'; sugD.innerHTML=''; }

  function getSuggestionPool(){
    const pool = new Map();
    Object.keys(skuMap || {}).forEach(s => {
      const n = trim(skuMap[s] || '');
      if(s) pool.set(s, n);
    });
    (Array.isArray(data) ? data : []).forEach(it => {
      const s = trim(it?.sku);
      const n = trim(it?.name);
      if(!s) return;
      if(!pool.has(s)) pool.set(s, n);
      if(pool.has(s) && !pool.get(s) && n) pool.set(s, n);
    });
    return Array.from(pool.entries()).map(([sku, name]) => ({ sku, name }));
  }

  function updateSuggestions(){
    const val = trim(skuI.value);
    sugD.innerHTML = '';

    if(skuMap[val]) nameI.value = skuMap[val];
    if(val.length < 2){ hideSuggestions(); return; }

    const q = val.toLowerCase();
    const pool = getSuggestionPool();
    const matches = pool
      .filter(x => x.sku.toLowerCase().includes(q) || (x.name || '').toLowerCase().includes(q))
      .slice(0, 8);

    if(matches.length === 0){ hideSuggestions(); return; }

    matches.forEach(m => {
      const div = document.createElement('div');
      div.className = 'sug-item';
      const b = document.createElement('b'); b.textContent = m.sku;
      const sm = document.createElement('small'); sm.textContent = m.name || '(ch∆∞a c√≥ t√™n)';
      div.appendChild(b); div.appendChild(sm);
      div.addEventListener('click', () => {
        skuI.value = m.sku;
        if(m.name) nameI.value = m.name;
        hideSuggestions();
        hsdI.focus();
      });
      sugD.appendChild(div);
    });

    sugD.style.display = 'block';
  }

  document.addEventListener('click', (e) => {
    if(!e.target.closest('.input-group')) hideSuggestions();
  });

  // ========= Edit mode =========
  function enterEdit(id){
    const item = data.find(x => x.id === id);
    if(!item) return;
    editingId = id;
    skuI.value = item.sku;
    nameI.value = item.name;
    hsdI.value = item.hsd;
    btnSave.textContent = '‚úÖ C·∫≠p nh·∫≠t';
    editRow.style.display = 'flex';
    hideSuggestions();
    showToast('‚úèÔ∏è ƒêang s·ª≠a d√≤ng');
  }

  function exitEdit(){
    editingId = null;
    btnSave.textContent = 'üíæ L∆∞u l·∫°i';
    editRow.style.display = 'none';
    skuI.value=''; nameI.value=''; hsdI.value='';
    hideSuggestions();
  }

  // ========= Upsert =========
  async function upsert(){
    if(!storageAvailable()){
      showToast('‚ùå localStorage b·ªã ch·∫∑n (m·ªü Safari/Chrome th·∫≠t, kh√¥ng ·∫©n danh/webview)');
      return;
    }

    const s = trim(skuI.value);
    const nIn = trim(nameI.value);
    const h = normalizeDateToISO(hsdI.value);

    if(!s){ showToast('‚ö†Ô∏è Vui l√≤ng nh·∫≠p SKU'); skuI.focus(); return; }
    if(!validISODate(h)){ showToast('‚ö†Ô∏è HSD kh√¥ng h·ª£p l·ªá'); hsdI.focus(); return; }

    const finalName = nIn || skuMap[s] || 'S·∫£n ph·∫©m m·ªõi';

    if(skuMap[s] && nIn && skuMap[s] !== nIn){
      const ok = await openConfirm({
        title:'ƒê·ªïi t√™n SKU?',
        text:`SKU "${s}" ƒëang l√† "${skuMap[s]}". ƒê·ªïi th√†nh "${nIn}" cho t·∫•t c·∫£ d√≤ng c√πng SKU?`,
        okText:'ƒê·ªïi t·∫•t c·∫£',
        cancelText:'Gi·ªØ t√™n c≈©'
      });
      if(ok){
        skuMap[s] = nIn;
        data.forEach(it => { if(it.sku === s) it.name = nIn; });
      }else{
        nameI.value = skuMap[s];
      }
    }

    if(!skuMap[s] || (finalName && finalName !== 'S·∫£n ph·∫©m m·ªõi')) {
      skuMap[s] = trim(nameI.value) || skuMap[s] || finalName;
    }

    if(editingId){
      const idx = data.findIndex(x => x.id === editingId);
      if(idx === -1){ showToast('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y d√≤ng ƒë·ªÉ s·ª≠a'); exitEdit(); return; }

      const dup = data.find(x => x.id !== editingId && x.sku === s && x.hsd === h);
      if(dup){
        const ok = await openConfirm({
          title:'Tr√πng SKU + HSD',
          text:'ƒê√£ c√≥ d√≤ng kh√°c c√πng SKU v√† HSD. B·∫°n mu·ªën g·ªôp (xo√° d√≤ng ƒëang s·ª≠a)?',
          okText:'G·ªôp',
          cancelText:'Kh√¥ng'
        });
        if(ok){
          dup.name = skuMap[s] || finalName;
          data.splice(idx, 1);
          saveStorage();
          render();
          showToast('‚úÖ ƒê√£ g·ªôp');
          exitEdit();
        }
        return;
      }

      data[idx].sku = s;
      data[idx].hsd = h;
      data[idx].name = skuMap[s] || finalName;

      saveStorage();
      render();
      showToast('‚úÖ ƒê√£ c·∫≠p nh·∫≠t');
      exitEdit();
      return;
    }

    const exist = data.find(x => x.sku === s && x.hsd === h);
    if(exist){
      const ok = await openConfirm({
        title:'ƒê√£ t·ªìn t·∫°i',
        text:'D√≤ng n√†y (c√πng SKU + HSD) ƒë√£ c√≥. C·∫≠p nh·∫≠t t√™n cho d√≤ng ƒë√≥?',
        okText:'C·∫≠p nh·∫≠t',
        cancelText:'Th√™m m·ªõi'
      });

      if(ok){
        exist.name = skuMap[s] || finalName;
      }else{
        data.push({ id: uid(), sku:s, name: skuMap[s] || finalName, hsd:h, createdAt: now() });
      }

      saveStorage();
      render();
      showToast('‚úÖ Xong');
      skuI.value=''; nameI.value=''; hsdI.value='';
      return;
    }

    data.push({ id: uid(), sku:s, name: skuMap[s] || finalName, hsd:h, createdAt: now() });
    saveStorage();
    render();
    showToast('‚úÖ ƒê√£ l∆∞u');
    skuI.value=''; nameI.value=''; hsdI.value='';
  }

  async function deleteById(id){
    const item = data.find(x => x.id === id);
    if(!item) return;

    const ok = await openConfirm({
      title:'Xo√° d√≤ng?',
      text:`Xo√° "${item.name}" (SKU ${item.sku}, HSD ${fmtDMY(item.hsd)})?`,
      okText:'Xo√°',
      cancelText:'Hu·ª∑'
    });
    if(!ok) return;

    data = data.filter(x => x.id !== id);
    saveStorage();
    render();
    showToast('üóëÔ∏è ƒê√£ xo√°');
    if(editingId === id) exitEdit();
  }

  // ========= Render =========
  function computeSummary(items){
    let expired=0, le7=0, le30=0;
    items.forEach(it => {
      const d = daysLeft(it.hsd);
      if(d < 0) expired++;
      if(d >= 0 && d <= 7) le7++;
      if(d >= 0 && d <= 30) le30++;
    });
    sumTotal.textContent = String(items.length);
    sumExpired.textContent = String(expired);
    sum7.textContent = String(le7);
    sum30.textContent = String(le30);
  }

  function render(){
    data = (Array.isArray(data)?data:[]).filter(x => x && x.id && x.sku && validISODate(x.hsd));
    computeSummary(data);

    const key = trim(searchI.value).toLowerCase();
    const filtered = data.filter(it => {
      if(!key) return true;
      const hay = `${it.name} ${it.sku} ${it.hsd} ${fmtDMY(it.hsd)}`.toLowerCase();
      return hay.includes(key);
    });

    filtered.sort((a,b) => {
      const da = daysLeft(a.hsd);
      const db = daysLeft(b.hsd);
      if(da !== db) return da - db;
      return a.sku.localeCompare(b.sku);
    });

    listEl.innerHTML = '';

    if(filtered.length === 0){
      const empty = document.createElement('div');
      empty.style.textAlign = 'center';
      empty.style.color = '#64748b';
      empty.style.fontWeight = '900';
      empty.style.padding = '18px 8px';
      empty.textContent = key ? 'Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£.' : 'Ch∆∞a c√≥ d·ªØ li·ªáu. Nh·∫≠p SKU + HSD ƒë·ªÉ l∆∞u.';
      listEl.appendChild(empty);
      return;
    }

    const frag = document.createDocumentFragment();

    filtered.forEach(it => {
      const d = daysLeft(it.hsd);
      const st = statusFor(d);

      const card = document.createElement('div');
      card.className = 'item ' + st.cls;

      const name = document.createElement('div');
      name.className = 'p-name';
      name.textContent = it.name || 'S·∫£n ph·∫©m';

      const skuLine = document.createElement('div');
      const sku = document.createElement('span');
      sku.className = 'p-sku';
      sku.textContent = it.sku;
      skuLine.appendChild(sku);

      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.appendChild(document.createTextNode('HSD: '));
      const b = document.createElement('b');
      b.textContent = fmtDMY(it.hsd);
      meta.appendChild(b);

      const status = document.createElement('div');
      status.className = 't-status ' + st.tcls;
      status.textContent = st.text;

      // ‚úÖ C·ª•m tr√™n: ch·ªâ Xo√°
      const actTop = document.createElement('div');
      actTop.className = 'action-top';

      // ‚úÖ C·ª•m d∆∞·ªõi: S·ª≠a (tr√°i) + Copy (ph·∫£i) n·∫±m ngang
      const actBottom = document.createElement('div');
      actBottom.className = 'action-bottom';

      const btnEdit = document.createElement('div');
      btnEdit.className = 'icon-btn';
      btnEdit.title = 'S·ª≠a';
      btnEdit.textContent = '‚úèÔ∏è';
      btnEdit.addEventListener('click', () => enterEdit(it.id));

      const btnCopy = document.createElement('div');
      btnCopy.className = 'icon-btn';
      btnCopy.title = 'Copy SKU';
      btnCopy.textContent = 'üìã';
      btnCopy.addEventListener('click', async () => {
        try { await navigator.clipboard.writeText(it.sku); showToast('üìã ƒê√£ copy SKU'); }
        catch { showToast('‚ö†Ô∏è Clipboard b·ªã ch·∫∑n'); }
      });

      const btnDel = document.createElement('div');
      btnDel.className = 'icon-btn danger';
      btnDel.title = 'Xo√°';
      btnDel.textContent = 'üóëÔ∏è';
      btnDel.addEventListener('click', () => deleteById(it.id));

      actTop.appendChild(btnDel);

      // ‚úÖ tr√°i s·ª≠a - ph·∫£i copy
      actBottom.appendChild(btnEdit);
      actBottom.appendChild(btnCopy);

      card.appendChild(name);
      card.appendChild(skuLine);
      card.appendChild(meta);
      card.appendChild(status);
      card.appendChild(actTop);
      card.appendChild(actBottom);

      frag.appendChild(card);
    });

    listEl.appendChild(frag);
  }

  // ========= CSV =========
  function detectDelimiter(text){
    const cleaned = text.replace(/^\uFEFF/, '');
    const lines = cleaned.split(/\r?\n/).filter(l => l.trim() !== '');
    const first = lines[0] || '';
    const c = (first.match(/,/g) || []).length;
    const s = (first.match(/;/g) || []).length;
    return s > c ? ';' : ',';
  }

  function parseCSV(text, delimiter){
    const rows = [];
    let row = [];
    let field = '';
    let i = 0;
    let inQuotes = false;

    text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');

    while(i < text.length){
      const ch = text[i];

      if(inQuotes){
        if(ch === '"'){
          if(text[i+1] === '"'){ field += '"'; i += 2; continue; }
          inQuotes = false; i++; continue;
        }
        field += ch; i++; continue;
      }else{
        if(ch === '"'){ inQuotes = true; i++; continue; }
        if(ch === delimiter){ row.push(field); field = ''; i++; continue; }
        if(ch === '\n'){
          row.push(field);
          if(row.some(v => trim(v) !== '')) rows.push(row);
          row = []; field = ''; i++; continue;
        }
        field += ch; i++; continue;
      }
    }

    row.push(field);
    if(row.some(v => trim(v) !== '')) rows.push(row);
    return rows;
  }

  function toCSVCell(v){
    v = (v ?? '').toString();
    const needs = /[",;\n\r]/.test(v);
    v = v.replace(/"/g, '""');
    return needs ? `"${v}"` : v;
  }

  async function importCSV(file){
    try{
      const text = await file.text();
      const delimiter = detectDelimiter(text);
      const rows = parseCSV(text.replace(/^\uFEFF/, ''), delimiter);

      if(rows.length === 0){ showToast('‚ö†Ô∏è CSV tr·ªëng'); return; }

      const header = rows[0].map(h => trim(h).toLowerCase());
      const hasHeader =
        header.includes('sku') || header.includes('barcode') || header.includes('name') ||
        header.includes('hsd') || header.includes('expiry') || header.includes('exp') ||
        header.includes('ma san pham') || header.includes('m√£ s·∫£n ph·∫©m') ||
        header.includes('ten san pham') || header.includes('t√™n s·∫£n ph·∫©m') ||
        header.includes('han su dung') || header.includes('h·∫°n s·ª≠ d·ª•ng');

      let start = hasHeader ? 1 : 0;

      const colIndex = (keys, fallback) => {
        for (const k of keys) {
          const idx = header.indexOf(k);
          if (idx >= 0) return idx;
        }
        return fallback;
      };

      const idxSku = hasHeader ? colIndex(['sku','barcode','ma san pham','m√£ s·∫£n ph·∫©m'], 0) : 0;
      const idxName = hasHeader ? colIndex(['name','ten san pham','t√™n s·∫£n ph·∫©m'], 1) : 1;
      const idxHsd  = hasHeader ? colIndex(['hsd','expiry','exp','han su dung','h·∫°n s·ª≠ d·ª•ng'], 2) : 2;

      let mapAdded = 0;
      let added = 0, updated = 0, skipped = 0;

      for(let r=start; r<rows.length; r++){
        const row = rows[r];
        if(!row || row.length === 0) continue;

        const s = trim(row[idxSku] ?? '');
        const n = trim(row[idxName] ?? '');
        if(!s){ skipped++; continue; }

        const rawH = row[idxHsd];
        const h = normalizeDateToISO(rawH ?? '');

        if(!rawH || !trim(rawH) || !validISODate(h)){
          const finalName = n || skuMap[s] || 'S·∫£n ph·∫©m m·ªõi';
          if(!skuMap[s] || (n && n !== skuMap[s])) {
            skuMap[s] = finalName;
            mapAdded++;
          }
          continue;
        }

        const finalName = n || skuMap[s] || 'S·∫£n ph·∫©m m·ªõi';
        if(!skuMap[s] || (finalName && finalName !== 'S·∫£n ph·∫©m m·ªõi')) skuMap[s] = finalName;

        const exist = data.find(x => x.sku === s && x.hsd === h);
        if(exist){
          exist.name = skuMap[s] || finalName;
          updated++;
        }else{
          data.push({ id: uid(), sku:s, name: skuMap[s] || finalName, hsd:h, createdAt: now() });
          added++;
        }
      }

      saveStorage();
      render();
      showToast(`‚úÖ Import: Danh m·ª•c +${mapAdded}, HSD +${added}, c·∫≠p nh·∫≠t ${updated}, b·ªè qua ${skipped}`);
    }catch(e){
      showToast('‚ùå Import l·ªói');
    }
  }

  function exportCSV(){
    try{
      const out = [...data].sort((a,b) => a.hsd.localeCompare(b.hsd));
      let csv = '\uFEFF' + ['sku','name','hsd'].join(',') + '\n';
      out.forEach(it => {
        csv += [toCSVCell(it.sku), toCSVCell(it.name), toCSVCell(it.hsd)].join(',') + '\n';
      });

      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'kiem_date.csv';
      a.rel = 'noopener';
      a.click();
      setTimeout(() => URL.revokeObjectURL(url), 1500);

      showToast('üì§ ƒê√£ xu·∫•t CSV');
    }catch(e){
      showToast('‚ùå Kh√¥ng xu·∫•t ƒë∆∞·ª£c');
    }
  }

  // ========= Clipboard paste =========
  async function smartPaste(){
    try{
      const t = await navigator.clipboard.readText();
      if(!t){ showToast('‚ö†Ô∏è Clipboard tr·ªëng'); return; }
      skuI.value = trim(t);
      updateSuggestions();
      hsdI.focus();
      showToast('üìã ƒê√£ d√°n SKU');
    }catch(e){
      showToast('‚ö†Ô∏è Clipboard b·ªã ch·∫∑n');
    }
  }

  // ========= Events =========
  skuI.addEventListener('input', updateSuggestions);
  searchI.addEventListener('input', render);

  btnPaste.addEventListener('click', smartPaste);
  btnSave.addEventListener('click', upsert);

  btnCancelEdit.addEventListener('click', () => { exitEdit(); showToast('‚Ü©Ô∏è ƒê√£ hu·ª∑ s·ª≠a'); });
  btnDeleteEdit.addEventListener('click', async () => { if(editingId) await deleteById(editingId); });

  btnImport.addEventListener('click', () => csvIn.click());
  csvIn.addEventListener('change', async () => {
    const f = csvIn.files && csvIn.files[0];
    if(!f) return;
    await importCSV(f);
    csvIn.value = '';
  });

  btnExport.addEventListener('click', exportCSV);

  btnClearAll.addEventListener('click', async () => {
    const ok = await openConfirm({
      title:'Xo√° to√†n b·ªô?',
      text:'B·∫°n mu·ªën xo√° t·∫•t c·∫£ d·ªØ li·ªáu trong m√°y? (Kh√¥ng kh√¥i ph·ª•c ƒë∆∞·ª£c)',
      okText:'Xo√° ALL',
      cancelText:'Hu·ª∑'
    });
    if(!ok) return;
    data = [];
    skuMap = {};
    editingId = null;
    saveStorage();
    render();
    exitEdit();
    showToast('üßπ ƒê√£ xo√° to√†n b·ªô');
  });

  // ========= Init =========
  if(!storageAvailable()){
    showToast('‚ö†Ô∏è localStorage b·ªã ch·∫∑n (m·ªü Safari/Chrome th·∫≠t, kh√¥ng ·∫©n danh/webview)', 2400);
  }
  loadStorage();
  render();
})();
</script>
</body>
</html>