<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>

  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="KI·ªÇM DATE" />
  <link rel="apple-touch-icon" href="icon.png.PNG" />
  <link rel="icon" type="image/png" href="icon.png.PNG" />

  <title>KI·ªÇM DATE</title>

  <style>
    :root{
      --bg:#f3f6fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:rgba(15,23,42,.08);

      --primary:#1a73e8;
      --primary2:#60a5fa;

      --danger:#ef4444;
      --warn:#f59e0b;
      --ok:#16a34a;

      --shadow: 0 10px 30px rgba(2,6,23,.08);
      --shadow2: 0 6px 16px rgba(2,6,23,.08);

      --radius:22px;
      --radius2:16px;

      --tap: rgba(26,115,232,.12);
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      background:linear-gradient(180deg, #eef5ff 0%, var(--bg) 45%, var(--bg) 100%);
      color:var(--text);
      font-family:-apple-system, system-ui, Segoe UI, Roboto, sans-serif;
      -webkit-font-smoothing:antialiased;
      padding: 12px;
    }

    .app{
      max-width:560px;
      margin:0 auto;
      padding-bottom: 26px;
    }

    /* ===== Header / Brand ===== */
    .brand{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      margin: 6px 0 12px;
      user-select:none;
    }
    .brand-badge{
      width:38px; height:38px;
      border-radius:14px;
      display:grid; place-items:center;
      background: radial-gradient(circle at 30% 30%, #ffffff 0%, #e8f2ff 45%, #cfe6ff 100%);
      border:1px solid rgba(26,115,232,.18);
      box-shadow: 0 8px 20px rgba(26,115,232,.12);
      font-size:18px;
    }
    .brand-title{
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      line-height:1.1;
    }
    .brand-title h1{
      margin:0;
      font-size:22px;
      letter-spacing:.2px;
      font-weight:1000;
      color: #185abc;
    }
    .brand-title .hint{
      margin-top:3px;
      font-size:12px;
      font-weight:800;
      color: var(--muted);
    }

    /* ===== Cards ===== */
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    /* ===== Form ===== */
    .form{
      padding:16px;
      margin-bottom:12px;
    }

    .field{
      margin-bottom:12px;
      position:relative; /* important for suggestions */
    }

    .label{
      font-size:12px;
      font-weight:950;
      color:#1e40af;
      margin:0 0 6px 10px;
      letter-spacing:.2px;
    }

    .control{
      position:relative;
    }

    .input{
      width:100%;
      height:50px;
      border-radius:18px;
      border:1.5px solid rgba(26,115,232,.14);
      background: linear-gradient(180deg, #fbfdff 0%, #f6faff 100%);
      padding: 0 14px 0 44px;
      font-size:16px;
      text-align:left;
      outline:none;
      color:var(--text);
      box-shadow: 0 1px 0 rgba(2,6,23,.03) inset;
    }
    .input::placeholder{ color: rgba(100,116,139,.85); font-weight:700; }
    .input:focus{
      border-color: rgba(26,115,232,.45);
      box-shadow: 0 0 0 4px rgba(26,115,232,.12);
      background:#ffffff;
    }
    input[type="date"].input{
      -webkit-appearance:none;
      padding-left: 44px;
      padding-right: 14px;
    }

    .icon{
      position:absolute;
      left:12px;
      top:50%;
      transform:translateY(-50%);
      width:26px; height:26px;
      border-radius:10px;
      display:grid; place-items:center;
      background: rgba(26,115,232,.08);
      border:1px solid rgba(26,115,232,.10);
      color:#1d4ed8;
      font-size:14px;
      user-select:none;
      pointer-events:none;
    }

    .row{
      display:flex;
      gap:10px;
      margin-top:4px;
    }
    .btn{
      flex:1;
      height:50px;
      border:none;
      border-radius:18px;
      font-weight:1000;
      font-size:15px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      color:#fff;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
      transition: transform .06s ease, filter .12s ease;
    }
    .btn:active{ transform: scale(.99); filter:brightness(.98); }
    .btn-primary{
      background: linear-gradient(180deg, var(--primary2) 0%, var(--primary) 100%);
      box-shadow: 0 10px 20px rgba(26,115,232,.18);
    }
    .btn-soft{
      background: linear-gradient(180deg, #93c5fd 0%, #60a5fa 100%);
      box-shadow: 0 10px 20px rgba(96,165,250,.18);
    }
    .btn-ghost{
      background: #eef2ff;
      color:#1e40af;
      border:1px solid rgba(30,64,175,.14);
      box-shadow:none;
    }
    .btn-danger{
      background: linear-gradient(180deg, #fb7185 0%, var(--danger) 100%);
      box-shadow: 0 10px 20px rgba(239,68,68,.14);
    }

    .editbar{
      display:none;
      gap:10px;
      margin-top:10px;
    }

    /* ===== Suggestions ===== */
    .suggestions{
      position:absolute;
      top: calc(100% + 8px);
      left: 0;
      right: 0;
      background: rgba(255,255,255,.98);
      border:1px solid rgba(15,23,42,.10);
      border-radius: 18px;
      box-shadow: 0 18px 40px rgba(2,6,23,.16);
      overflow:hidden;
      display:none;
      z-index: 50;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      max-height: 230px;
      overflow-y: auto;
    }
    .sug-item{
      padding: 12px 14px;
      cursor:pointer;
      border-bottom:1px solid rgba(15,23,42,.06);
    }
    .sug-item:last-child{ border-bottom:none; }
    .sug-item:active{ background: rgba(26,115,232,.08); }
    /* theo y√™u c·∫ßu c·ªßa b·∫°n: KH√îNG l√†m SKU ƒë·∫≠m h∆°n v√† t√™n m·ªù h∆°n */
    .sug-sku{ font-weight:900; color: #0f172a; font-size:14px; }
    .sug-name{ margin-top:2px; font-weight:900; color:#0f172a; font-size:13px; }

    /* ===== Summary ===== */
    .summary{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
      margin: 10px 0 12px;
    }
    .chip{
      background: linear-gradient(180deg, #ffffff 0%, #fbfdff 100%);
      border:1px solid rgba(15,23,42,.08);
      border-radius: 18px;
      padding: 10px 8px;
      box-shadow: var(--shadow2);
      text-align:center;
    }
    .chip .n{
      font-size:18px;
      font-weight:1100;
      letter-spacing:.2px;
      color: #0f172a;
      line-height:1.1;
    }
    .chip .t{
      margin-top:3px;
      font-size:11px;
      color: var(--muted);
      font-weight:900;
    }
    @media (max-width:420px){
      .summary{ grid-template-columns: repeat(2, 1fr); }
    }

    /* ===== Tools ===== */
    .tools{
      padding:12px;
      margin-bottom:12px;
    }
    .tool-row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .tool-btn{
      flex:1;
      min-width: 120px;
      height:42px;
      border-radius: 14px;
      font-weight:1000;
      font-size:13px;
      cursor:pointer;
      border:1.5px solid rgba(26,115,232,.22);
      color:#1e40af;
      background: #ffffff;
      box-shadow: 0 8px 18px rgba(2,6,23,.06);
      transition: transform .06s ease;
      -webkit-tap-highlight-color:transparent;
    }
    .tool-btn:active{ transform: scale(.995); }
    .tool-btn.primary{
      background: linear-gradient(180deg, #60a5fa 0%, #1a73e8 100%);
      color:#fff;
      border:none;
    }
    .tool-btn.danger{
      border-color: rgba(239,68,68,.25);
      color: #b91c1c;
      background: #fff;
    }
    .search{
      width:100%;
      height:46px;
      border-radius: 22px;
      border:1.5px solid rgba(15,23,42,.10);
      background:#ffffff;
      padding: 0 14px;
      font-size:15px;
      outline:none;
      text-align:center;
      font-weight:800;
      color:#0f172a;
    }
    .search:focus{
      border-color: rgba(26,115,232,.45);
      box-shadow: 0 0 0 4px rgba(26,115,232,.10);
    }

    /* ===== List item ===== */
    .list{ margin-top: 6px; }
    .item{
      position:relative;
      border-radius: 22px;
      border:1px solid rgba(15,23,42,.08);
      background: #fff;
      box-shadow: var(--shadow2);
      padding: 14px 14px 14px 14px;
      padding-right: 86px;
      margin-bottom: 12px;
      overflow:hidden;
    }
    .stripe{
      position:absolute; left:0; top:0; bottom:0;
      width:7px;
      background: rgba(100,116,139,.35);
    }
    .item.red  .stripe{ background: rgba(239,68,68,.92); }
    .item.warn .stripe{ background: rgba(245,158,11,.92); }
    .item.ok   .stripe{ background: rgba(22,163,74,.85); }

    .pname{
      font-weight:1100;
      color:#0b3b8f;
      font-size:15px;
      text-transform:uppercase;
      letter-spacing:.2px;
      margin: 0 0 6px;
      word-break:break-word;
    }
    .sku{
      display:inline-block;
      padding: 4px 8px;
      border-radius: 10px;
      background: rgba(26,115,232,.10);
      border:1px solid rgba(26,115,232,.14);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      font-weight: 900;
      color:#0f3a9b;
      max-width: 100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .meta{
      margin-top: 6px;
      font-size: 13px;
      font-weight: 850;
      color: rgba(15,23,42,.78);
    }
    .status{
      margin-top: 8px;
      font-size: 14px;
      font-weight: 1100;
      letter-spacing:.1px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width: 26px;
      height: 26px;
      border-radius: 12px;
      font-size: 14px;
      border: 1px solid rgba(15,23,42,.06);
      background: rgba(100,116,139,.08);
    }
    .item.red  .badge{ background: rgba(239,68,68,.10); border-color: rgba(239,68,68,.16); }
    .item.warn .badge{ background: rgba(245,158,11,.12); border-color: rgba(245,158,11,.18); }
    .item.ok   .badge{ background: rgba(22,163,74,.10); border-color: rgba(22,163,74,.16); }

    .status.red{ color: #b91c1c; }
    .status.warn{ color: #b45309; }
    .status.ok{ color: #166534; }

    .actions{
      position:absolute;
      right: 10px;
      top: 10px;
      width: 64px;
      background: rgba(241,245,249,.75);
      border:1px solid rgba(15,23,42,.08);
      border-radius: 18px;
      padding: 8px;
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:center;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .iconbtn{
      width:42px;
      height:42px;
      border-radius: 14px;
      border:1px solid rgba(15,23,42,.08);
      background: #ffffff;
      display:grid;
      place-items:center;
      font-size:18px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
      box-shadow: 0 8px 16px rgba(2,6,23,.08);
      transition: transform .06s ease;
    }
    .iconbtn:active{ transform: scale(.985); background: var(--tap); }
    .iconbtn.danger{
      background: rgba(239,68,68,.06);
      border-color: rgba(239,68,68,.18);
    }

    @media (max-width:380px){
      .actions{ width: 60px; right: 8px; }
      .iconbtn{ width:40px; height:40px; }
      .item{ padding-right: 82px; }
    }

    /* ===== Empty state ===== */
    .empty{
      margin: 12px 0 0;
      padding: 18px 14px;
      text-align:center;
      color: var(--muted);
      font-weight: 900;
      border-radius: 22px;
      border:1px dashed rgba(15,23,42,.14);
      background: rgba(255,255,255,.7);
      box-shadow: 0 10px 22px rgba(2,6,23,.05);
    }
    .empty .emo{ font-size:24px; }
    .empty .t1{ margin-top:6px; color:#0f172a; font-size:14px; }
    .empty .t2{ margin-top:4px; font-size:12px; }

    /* ===== Toast ===== */
    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background: rgba(2,6,23,.92);
      color:#fff;
      padding: 10px 14px;
      border-radius: 16px;
      font-weight: 1000;
      font-size: 13px;
      display:none;
      z-index:999;
      max-width: 92%;
      text-align:center;
      box-shadow: 0 20px 40px rgba(2,6,23,.25);
    }

    /* ===== Modal confirm ===== */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background: rgba(2,6,23,.38);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:1000;
      padding: 14px;
    }
    .modal{
      width:100%;
      max-width: 560px;
      background: rgba(255,255,255,.96);
      border-radius: 22px;
      padding: 14px;
      border:1px solid rgba(255,255,255,.30);
      box-shadow: 0 30px 70px rgba(2,6,23,.35);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .modal h2{
      margin: 6px 6px 8px;
      font-size: 16px;
      font-weight: 1100;
      color:#0f172a;
    }
    .modal p{
      margin: 0 6px 12px;
      color: rgba(15,23,42,.70);
      font-size: 13px;
      font-weight: 900;
      line-height: 1.35;
    }
    .modal .row{ margin-top: 10px; }

    /* reduce motion */
    @media (prefers-reduced-motion: reduce){
      .btn, .tool-btn, .iconbtn{ transition:none; }
    }
  </style>
</head>

<body>
  <div class="app">

    <div class="brand">
      <div class="brand-badge">üìÖ</div>
      <div class="brand-title">
        <h1>KI·ªÇM DATE</h1>
        <div class="hint">Nh·∫≠p SKU ‚Ä¢ Ch·ªçn HSD ‚Ä¢ L∆∞u & theo d√µi</div>
      </div>
    </div>

    <!-- FORM -->
    <div class="card form">
      <div class="field">
        <div class="label">M√£ SKU / Barcode</div>
        <div class="control">
          <div class="icon">üè∑Ô∏è</div>
          <input id="sku" class="input" type="text" placeholder="Nh·∫≠p ho·∫∑c qu√©t m√£..." autocomplete="off" />
          <div id="suggestions" class="suggestions"></div>
        </div>
      </div>

      <div class="field">
        <div class="label">T√™n s·∫£n ph·∫©m</div>
        <div class="control">
          <div class="icon">üßæ</div>
          <input id="name" class="input" type="text" placeholder="T√™n s·∫£n ph·∫©m..." autocomplete="off" />
        </div>
      </div>

      <div class="field" style="margin-bottom:8px;">
        <div class="label">H·∫°n s·ª≠ d·ª•ng (HSD)</div>
        <div class="control">
          <div class="icon">üóìÔ∏è</div>
          <input id="hsd" class="input" type="date" />
        </div>
      </div>

      <div class="row">
        <button id="btnPaste" class="btn btn-soft" type="button">üìã D√°n m√£</button>
        <button id="btnSave" class="btn btn-primary" type="button">üíæ L∆∞u l·∫°i</button>
      </div>

      <div id="editRow" class="row editbar">
        <button id="btnCancelEdit" class="btn btn-ghost" type="button">‚Ü©Ô∏è Hu·ª∑ s·ª≠a</button>
        <button id="btnDeleteEdit" class="btn btn-danger" type="button">üóëÔ∏è Xo√° d√≤ng</button>
      </div>
    </div>

    <!-- SUMMARY -->
    <div class="summary">
      <div class="chip"><div id="sumTotal" class="n">0</div><div class="t">T·ªïng</div></div>
      <div class="chip"><div id="sumExpired" class="n">0</div><div class="t">H·∫øt h·∫°n</div></div>
      <div class="chip"><div id="sum7" class="n">0</div><div class="t">‚â§ 7 ng√†y</div></div>
      <div class="chip"><div id="sum30" class="n">0</div><div class="t">‚â§ 30 ng√†y</div></div>
    </div>

    <!-- TOOLS -->
    <div class="card tools">
      <div class="tool-row">
        <input type="file" id="csvIn" hidden accept=".csv,text/csv" />
        <button id="btnImport" class="tool-btn" type="button">üì• NH·∫¨P CSV</button>
        <button id="btnExport" class="tool-btn primary" type="button">üì§ XU·∫§T CSV</button>
        <button id="btnClearAll" class="tool-btn danger" type="button">üßπ XO√Å ALL</button>
      </div>
      <input id="search" class="search" type="text" placeholder="T√¨m t√™n / SKU / HSD..." />
    </div>

    <!-- LIST -->
    <div id="list" class="list"></div>

  </div>

  <div id="toast" class="toast"></div>

  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <h2 id="modalTitle">X√°c nh·∫≠n</h2>
      <p id="modalText">B·∫°n ch·∫Øc ch·ª©?</p>
      <div class="row">
        <button id="modalCancel" class="btn btn-ghost" type="button">Hu·ª∑</button>
        <button id="modalOk" class="btn btn-danger" type="button">ƒê·ªìng √Ω</button>
      </div>
    </div>
  </div>

<script>
(() => {
  // ========= DOM =========
  const skuI = document.getElementById('sku');
  const nameI = document.getElementById('name');
  const hsdI = document.getElementById('hsd');
  const sugD = document.getElementById('suggestions');

  const btnPaste = document.getElementById('btnPaste');
  const btnSave = document.getElementById('btnSave');

  const editRow = document.getElementById('editRow');
  const btnCancelEdit = document.getElementById('btnCancelEdit');
  const btnDeleteEdit = document.getElementById('btnDeleteEdit');

  const btnImport = document.getElementById('btnImport');
  const btnExport = document.getElementById('btnExport');
  const btnClearAll = document.getElementById('btnClearAll');
  const csvIn = document.getElementById('csvIn');

  const searchI = document.getElementById('search');
  const listEl = document.getElementById('list');

  const sumTotal = document.getElementById('sumTotal');
  const sumExpired = document.getElementById('sumExpired');
  const sum7 = document.getElementById('sum7');
  const sum30 = document.getElementById('sum30');

  const toastEl = document.getElementById('toast');
  const modalBackdrop = document.getElementById('modalBackdrop');
  const modalTitle = document.getElementById('modalTitle');
  const modalText = document.getElementById('modalText');
  const modalCancel = document.getElementById('modalCancel');
  const modalOk = document.getElementById('modalOk');

  // ========= Storage =========
  const KEY_V2 = 'kiemdate_v2';
  const KEY_V2_MAP = 'kiemdate_v2_skuMap';

  // ========= State =========
  let data = [];     // {id, sku, name, hsd, createdAt}
  let skuMap = {};   // {sku: name}
  let editingId = null;

  // ========= Utils =========
  const now = () => Date.now();
  const trim = (s) => (s ?? '').toString().trim();

  function uid() {
    if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
    return 'id_' + Math.random().toString(16).slice(2) + '_' + Date.now().toString(16);
  }

  function vibrate(ms=18){
    try{ if(navigator.vibrate) navigator.vibrate(ms); }catch{}
  }

  function showToast(msg, ms=1600){
    toastEl.textContent = msg;
    toastEl.style.display = 'block';
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=> toastEl.style.display='none', ms);
  }

  function openConfirm({title='X√°c nh·∫≠n', text='B·∫°n ch·∫Øc ch·ª©?', okText='ƒê·ªìng √Ω', cancelText='Hu·ª∑'}){
    return new Promise(resolve => {
      modalTitle.textContent = title;
      modalText.textContent = text;
      modalOk.textContent = okText;
      modalCancel.textContent = cancelText;
      modalBackdrop.style.display = 'flex';

      const cleanup = () => {
        modalBackdrop.style.display = 'none';
        modalCancel.removeEventListener('click', onCancel);
        modalOk.removeEventListener('click', onOk);
        modalBackdrop.removeEventListener('click', onBackdrop);
        document.removeEventListener('keydown', onKey);
      };

      const onCancel = () => { cleanup(); resolve(false); };
      const onOk = () => { cleanup(); resolve(true); };
      const onBackdrop = (e) => { if(e.target === modalBackdrop){ cleanup(); resolve(false); } };
      const onKey = (e) => { if(e.key === 'Escape'){ cleanup(); resolve(false); } };

      modalCancel.addEventListener('click', onCancel);
      modalOk.addEventListener('click', onOk);
      modalBackdrop.addEventListener('click', onBackdrop);
      document.addEventListener('keydown', onKey);
    });
  }

  function storageAvailable(){
    try{
      const k='__test__'+Math.random();
      localStorage.setItem(k,'1');
      localStorage.removeItem(k);
      return true;
    }catch{ return false; }
  }

  function normalizeDateToISO(v){
    v = trim(v);
    if(!v) return '';
    if(/^\d{4}-\d{2}-\d{2}$/.test(v)) return v;

    let m = v.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/); // dd/mm/yyyy
    if(m){
      const dd=String(m[1]).padStart(2,'0');
      const mm=String(m[2]).padStart(2,'0');
      const yy=m[3];
      return `${yy}-${mm}-${dd}`;
    }

    m = v.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/); // yyyy/mm/dd
    if(m){
      const yy=m[1];
      const mm=String(m[2]).padStart(2,'0');
      const dd=String(m[3]).padStart(2,'0');
      return `${yy}-${mm}-${dd}`;
    }

    const d = new Date(v);
    if(!isNaN(d.getTime())){
      const yy=d.getFullYear();
      const mm=String(d.getMonth()+1).padStart(2,'0');
      const dd=String(d.getDate()).padStart(2,'0');
      return `${yy}-${mm}-${dd}`;
    }
    return '';
  }

  function validISODate(iso){
    if(!/^\d{4}-\d{2}-\d{2}$/.test(iso)) return false;
    const d = new Date(iso + 'T12:00:00');
    if(isNaN(d.getTime())) return false;
    const [y,m,dd] = iso.split('-').map(Number);
    return d.getFullYear()===y && (d.getMonth()+1)===m && d.getDate()===dd;
  }

  function fmtDMY(iso){
    if(!iso || !/^\d{4}-\d{2}-\d{2}$/.test(iso)) return iso || '';
    const [y,m,d] = iso.split('-');
    return `${d}/${m}/${y}`;
  }

  function daysLeft(iso){
    const target = new Date(iso + 'T23:59:59');
    return Math.ceil((target.getTime() - now()) / 86400000);
  }

  function statusFor(d){
    if(d < 0) return { tone:'red',  emoji:'‚ùå', text:'ƒê√É H·∫æT H·∫†N' };
    if(d === 0) return { tone:'red',  emoji:'üî•', text:'H·∫øt h·∫°n h√¥m nay' };
    if(d <= 7) return { tone:'red',  emoji:'‚ö†Ô∏è', text:`S·∫Øp h·∫øt h·∫°n (${d} ng√†y)` };
    if(d <= 30) return { tone:'warn', emoji:'‚è∞', text:`C·∫≠n date (${d} ng√†y)` };
    return { tone:'ok',   emoji:'‚úÖ', text:`C√≤n ${d} ng√†y` };
  }

  function saveStorage(){
    try{
      localStorage.setItem(KEY_V2, JSON.stringify(data));
      localStorage.setItem(KEY_V2_MAP, JSON.stringify(skuMap));
      return true;
    }catch(e){
      showToast('‚ùå Kh√¥ng l∆∞u ƒë∆∞·ª£c (localStorage b·ªã ch·∫∑n)');
      return false;
    }
  }

  function loadStorage(){
    const v2 = localStorage.getItem(KEY_V2);
    const v2m = localStorage.getItem(KEY_V2_MAP);

    if(v2){
      try { data = JSON.parse(v2) || []; } catch { data = []; }
      try { skuMap = JSON.parse(v2m || '{}') || {}; } catch { skuMap = {}; }
      if(!Array.isArray(data)) data = [];
      return;
    }

    // migrate t·ª´ b·∫£n c≈© (n·∫øu c√≥)
    const oldDates = localStorage.getItem('dates');
    const oldMap = localStorage.getItem('skuMap');

    if(oldDates || oldMap){
      let od=[], om={};
      try { od = JSON.parse(oldDates || '[]') || []; } catch { od=[]; }
      try { om = JSON.parse(oldMap || '{}') || {}; } catch { om={}; }

      skuMap = (om && typeof om === 'object') ? om : {};
      data = [];

      (Array.isArray(od)?od:[]).forEach(item => {
        const s = trim(item?.sku);
        const h = normalizeDateToISO(item?.hsd);
        const n = trim(item?.name) || skuMap[s] || 'S·∫£n ph·∫©m m·ªõi';
        if(s && validISODate(h)){
          data.push({ id: uid(), sku:s, name:n, hsd:h, createdAt: now() });
          if(!skuMap[s]) skuMap[s]=n;
        }
      });

      saveStorage();
      showToast('‚úÖ ƒê√£ n√¢ng c·∫•p d·ªØ li·ªáu');
      return;
    }

    data = [];
    skuMap = {};
  }

  // ========= Suggestions (KH√îNG l√†m SKU ƒë·∫≠m + t√™n m·ªù) =========
  function hideSuggestions(){
    sugD.style.display = 'none';
    sugD.innerHTML = '';
  }

  function getSuggestionPool(){
    const pool = new Map();
    Object.keys(skuMap || {}).forEach(s => {
      const n = trim(skuMap[s] || '');
      if(s) pool.set(s, n);
    });
    (Array.isArray(data) ? data : []).forEach(it => {
      const s = trim(it?.sku);
      const n = trim(it?.name);
      if(!s) return;
      if(!pool.has(s)) pool.set(s, n);
      if(pool.has(s) && !pool.get(s) && n) pool.set(s, n);
    });
    return Array.from(pool.entries()).map(([sku, name]) => ({ sku, name }));
  }

  function updateSuggestions(){
    const val = trim(skuI.value);
    sugD.innerHTML = '';

    if(skuMap[val]) nameI.value = skuMap[val];
    if(val.length < 2){ hideSuggestions(); return; }

    const q = val.toLowerCase();
    const pool = getSuggestionPool();
    const matches = pool
      .filter(x =>
        x.sku.toLowerCase().includes(q) ||
        (x.name || '').toLowerCase().includes(q)
      )
      .slice(0, 8);

    if(matches.length === 0){ hideSuggestions(); return; }

    matches.forEach(m => {
      const div = document.createElement('div');
      div.className = 'sug-item';

      const skuLine = document.createElement('div');
      skuLine.className = 'sug-sku';
      skuLine.textContent = m.sku;

      const nameLine = document.createElement('div');
      nameLine.className = 'sug-name';
      nameLine.textContent = m.name || '(ch∆∞a c√≥ t√™n)';

      div.appendChild(skuLine);
      div.appendChild(nameLine);

      div.addEventListener('click', () => {
        skuI.value = m.sku;
        if(m.name) nameI.value = m.name;
        hideSuggestions();
        hsdI.focus();
      });

      sugD.appendChild(div);
    });

    sugD.style.display = 'block';
  }

  document.addEventListener('click', (e) => {
    // ƒë√≥ng dropdown n·∫øu click ra ngo√†i field SKU
    if(!e.target.closest('.field')) hideSuggestions();
  });

  // ========= Edit mode =========
  function enterEdit(id){
    const item = data.find(x => x.id === id);
    if(!item) return;
    editingId = id;
    skuI.value = item.sku;
    nameI.value = item.name;
    hsdI.value = item.hsd;

    btnSave.textContent = '‚úÖ C·∫≠p nh·∫≠t';
    editRow.style.display = 'flex';
    hideSuggestions();
    showToast('‚úèÔ∏è ƒêang s·ª≠a d√≤ng');
  }

  function exitEdit(){
    editingId = null;
    btnSave.textContent = 'üíæ L∆∞u l·∫°i';
    editRow.style.display = 'none';
    skuI.value=''; nameI.value=''; hsdI.value='';
    hideSuggestions();
  }

  // ========= Upsert =========
  async function upsert(){
    if(!storageAvailable()){
      showToast('‚ùå localStorage b·ªã ch·∫∑n (m·ªü Safari/Chrome th·∫≠t, kh√¥ng ·∫©n danh/webview)');
      vibrate(30);
      return;
    }

    const s = trim(skuI.value);
    const nIn = trim(nameI.value);
    const h = normalizeDateToISO(hsdI.value);

    if(!s){ showToast('‚ö†Ô∏è Vui l√≤ng nh·∫≠p SKU'); vibrate(25); skuI.focus(); return; }
    if(!validISODate(h)){ showToast('‚ö†Ô∏è HSD kh√¥ng h·ª£p l·ªá'); vibrate(25); hsdI.focus(); return; }

    const finalName = nIn || skuMap[s] || 'S·∫£n ph·∫©m m·ªõi';

    // ƒë·ªïi t√™n SKU (n·∫øu c√≥)
    if(skuMap[s] && nIn && skuMap[s] !== nIn){
      const ok = await openConfirm({
        title:'ƒê·ªïi t√™n SKU?',
        text:`SKU "${s}" ƒëang l√† "${skuMap[s]}". ƒê·ªïi th√†nh "${nIn}" cho t·∫•t c·∫£ d√≤ng c√πng SKU?`,
        okText:'ƒê·ªïi t·∫•t c·∫£',
        cancelText:'Gi·ªØ t√™n c≈©'
      });
      if(ok){
        skuMap[s] = nIn;
        data.forEach(it => { if(it.sku === s) it.name = nIn; });
      }else{
        nameI.value = skuMap[s];
      }
    }

    if(!skuMap[s] || (finalName && finalName !== 'S·∫£n ph·∫©m m·ªõi')){
      skuMap[s] = trim(nameI.value) || skuMap[s] || finalName;
    }

    // edit
    if(editingId){
      const idx = data.findIndex(x => x.id === editingId);
      if(idx === -1){ showToast('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y d√≤ng'); vibrate(25); exitEdit(); return; }

      const dup = data.find(x => x.id !== editingId && x.sku === s && x.hsd === h);
      if(dup){
        const ok = await openConfirm({
          title:'Tr√πng SKU + HSD',
          text:'ƒê√£ c√≥ d√≤ng kh√°c c√πng SKU v√† HSD. B·∫°n mu·ªën g·ªôp (xo√° d√≤ng ƒëang s·ª≠a)?',
          okText:'G·ªôp',
          cancelText:'Kh√¥ng'
        });
        if(ok){
          dup.name = skuMap[s] || finalName;
          data.splice(idx, 1);
          saveStorage();
          render();
          showToast('‚úÖ ƒê√£ g·ªôp');
          exitEdit();
        }
        return;
      }

      data[idx].sku = s;
      data[idx].hsd = h;
      data[idx].name = skuMap[s] || finalName;

      saveStorage();
      render();
      showToast('‚úÖ ƒê√£ c·∫≠p nh·∫≠t');
      exitEdit();
      return;
    }

    // create
    const exist = data.find(x => x.sku === s && x.hsd === h);
    if(exist){
      const ok = await openConfirm({
        title:'ƒê√£ t·ªìn t·∫°i',
        text:'D√≤ng n√†y (c√πng SKU + HSD) ƒë√£ c√≥. C·∫≠p nh·∫≠t t√™n cho d√≤ng ƒë√≥?',
        okText:'C·∫≠p nh·∫≠t',
        cancelText:'Th√™m m·ªõi'
      });

      if(ok){
        exist.name = skuMap[s] || finalName;
      }else{
        data.push({ id: uid(), sku:s, name: skuMap[s] || finalName, hsd:h, createdAt: now() });
      }

      saveStorage();
      render();
      showToast('‚úÖ Xong');
      skuI.value=''; nameI.value=''; hsdI.value='';
      return;
    }

    data.push({ id: uid(), sku:s, name: skuMap[s] || finalName, hsd:h, createdAt: now() });
    saveStorage();
    render();
    showToast('‚úÖ ƒê√£ l∆∞u');
    skuI.value=''; nameI.value=''; hsdI.value='';
  }

  async function deleteById(id){
    const item = data.find(x => x.id === id);
    if(!item) return;

    const ok = await openConfirm({
      title:'Xo√° d√≤ng?',
      text:`Xo√° "${item.name}" (SKU ${item.sku}, HSD ${fmtDMY(item.hsd)})?`,
      okText:'Xo√°',
      cancelText:'Hu·ª∑'
    });
    if(!ok) return;

    data = data.filter(x => x.id !== id);
    saveStorage();
    render();
    showToast('üóëÔ∏è ƒê√£ xo√°');
    if(editingId === id) exitEdit();
  }

  // ========= Render =========
  function computeSummary(items){
    let expired=0, le7=0, le30=0;
    items.forEach(it => {
      const d = daysLeft(it.hsd);
      if(d < 0) expired++;
      if(d >= 0 && d <= 7) le7++;
      if(d >= 0 && d <= 30) le30++;
    });
    sumTotal.textContent = String(items.length);
    sumExpired.textContent = String(expired);
    sum7.textContent = String(le7);
    sum30.textContent = String(le30);
  }

  function render(){
    data = (Array.isArray(data)?data:[]).filter(x => x && x.id && x.sku && validISODate(x.hsd));
    computeSummary(data);

    const key = trim(searchI.value).toLowerCase();
    const filtered = data.filter(it => {
      if(!key) return true;
      const hay = `${it.name} ${it.sku} ${it.hsd} ${fmtDMY(it.hsd)}`.toLowerCase();
      return hay.includes(key);
    });

    filtered.sort((a,b) => {
      const da = daysLeft(a.hsd);
      const db = daysLeft(b.hsd);
      if(da !== db) return da - db;
      return a.sku.localeCompare(b.sku);
    });

    listEl.innerHTML = '';

    if(filtered.length === 0){
      const empty = document.createElement('div');
      empty.className = 'empty';
      empty.innerHTML = `
        <div class="emo">üßä</div>
        <div class="t1">${key ? 'Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£.' : 'Ch∆∞a c√≥ d·ªØ li·ªáu.'}</div>
        <div class="t2">${key ? 'Th·ª≠ t·ª´ kho√° kh√°c (t√™n / SKU / HSD).' : 'Nh·∫≠p SKU + HSD r·ªìi b·∫•m ‚ÄúL∆∞u l·∫°i‚Äù.'}</div>
      `;
      listEl.appendChild(empty);
      return;
    }

    const frag = document.createDocumentFragment();

    filtered.forEach(it => {
      const d = daysLeft(it.hsd);
      const st = statusFor(d);

      const card = document.createElement('div');
      card.className = 'item ' + (st.tone === 'red' ? 'red' : st.tone === 'warn' ? 'warn' : 'ok');

      const stripe = document.createElement('div');
      stripe.className = 'stripe';

      const name = document.createElement('div');
      name.className = 'pname';
      name.textContent = it.name || 'S·∫£n ph·∫©m';

      const skuLine = document.createElement('div');
      const sku = document.createElement('span');
      sku.className = 'sku';
      sku.textContent = it.sku;
      skuLine.appendChild(sku);

      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.innerHTML = `HSD: <b>${fmtDMY(it.hsd)}</b>`;

      const status = document.createElement('div');
      status.className = 'status ' + st.tone;
      const badge = document.createElement('span');
      badge.className = 'badge';
      badge.textContent = st.emoji;
      const txt = document.createElement('span');
      txt.textContent = st.text;
      status.appendChild(badge);
      status.appendChild(txt);

      const actions = document.createElement('div');
      actions.className = 'actions';

      const bCopy = document.createElement('div');
      bCopy.className = 'iconbtn';
      bCopy.title = 'Copy SKU';
      bCopy.textContent = 'üìã';
      bCopy.addEventListener('click', async () => {
        try{
          await navigator.clipboard.writeText(it.sku);
          showToast('üìã ƒê√£ copy SKU');
          vibrate(10);
        }catch{
          showToast('‚ö†Ô∏è Clipboard b·ªã ch·∫∑n');
          vibrate(25);
        }
      });

      const bEdit = document.createElement('div');
      bEdit.className = 'iconbtn';
      bEdit.title = 'S·ª≠a';
      bEdit.textContent = '‚úèÔ∏è';
      bEdit.addEventListener('click', () => enterEdit(it.id));

      const bDel = document.createElement('div');
      bDel.className = 'iconbtn danger';
      bDel.title = 'Xo√°';
      bDel.textContent = 'üóëÔ∏è';
      bDel.addEventListener('click', () => deleteById(it.id));

      actions.appendChild(bCopy);
      actions.appendChild(bEdit);
      actions.appendChild(bDel);

      card.appendChild(stripe);
      card.appendChild(name);
      card.appendChild(skuLine);
      card.appendChild(meta);
      card.appendChild(status);
      card.appendChild(actions);

      frag.appendChild(card);
    });

    listEl.appendChild(frag);
  }

  // ========= CSV =========
  function detectDelimiter(text){
    const cleaned = text.replace(/^\uFEFF/, '');
    const lines = cleaned.split(/\r?\n/).filter(l => l.trim() !== '');
    const first = lines[0] || '';
    const c = (first.match(/,/g) || []).length;
    const s = (first.match(/;/g) || []).length;
    return s > c ? ';' : ',';
  }

  function parseCSV(text, delimiter){
    // CSV parser h·ªó tr·ª£ quotes + delimiter trong quotes
    const rows = [];
    let row = [];
    let field = '';
    let i = 0;
    let inQuotes = false;

    text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');

    while(i < text.length){
      const ch = text[i];

      if(inQuotes){
        if(ch === '"'){
          if(text[i+1] === '"'){ field += '"'; i += 2; continue; }
          inQuotes = false; i++; continue;
        }
        field += ch; i++; continue;
      }else{
        if(ch === '"'){ inQuotes = true; i++; continue; }
        if(ch === delimiter){ row.push(field); field = ''; i++; continue; }
        if(ch === '\n'){
          row.push(field);
          if(row.some(v => trim(v) !== '')) rows.push(row);
          row = []; field = ''; i++; continue;
        }
        field += ch; i++; continue;
      }
    }

    row.push(field);
    if(row.some(v => trim(v) !== '')) rows.push(row);
    return rows;
  }

  function toCSVCell(v){
    v = (v ?? '').toString();
    const needs = /[",;\n\r]/.test(v);
    v = v.replace(/"/g, '""');
    return needs ? `"${v}"` : v;
  }

  async function importCSV(file){
    try{
      const text = await file.text();
      const delimiter = detectDelimiter(text);
      const rows = parseCSV(text.replace(/^\uFEFF/, ''), delimiter);

      if(rows.length === 0){ showToast('‚ö†Ô∏è CSV tr·ªëng'); vibrate(25); return; }

      const header = rows[0].map(h => trim(h).toLowerCase());
      const hasHeader =
        header.includes('sku') || header.includes('barcode') || header.includes('name') ||
        header.includes('hsd') || header.includes('expiry') || header.includes('exp') ||
        header.includes('ma san pham') || header.includes('m√£ s·∫£n ph·∫©m') ||
        header.includes('ten san pham') || header.includes('t√™n s·∫£n ph·∫©m') ||
        header.includes('han su dung') || header.includes('h·∫°n s·ª≠ d·ª•ng');

      const start = hasHeader ? 1 : 0;

      const colIndex = (keys, fallback) => {
        for (const k of keys) {
          const idx = header.indexOf(k);
          if (idx >= 0) return idx;
        }
        return fallback;
      };

      const idxSku = hasHeader ? colIndex(['sku','barcode','ma san pham','m√£ s·∫£n ph·∫©m'], 0) : 0;
      const idxName = hasHeader ? colIndex(['name','ten san pham','t√™n s·∫£n ph·∫©m'], 1) : 1;
      const idxHsd  = hasHeader ? colIndex(['hsd','expiry','exp','han su dung','h·∫°n s·ª≠ d·ª•ng'], 2) : 2;

      let mapAdded = 0;
      let added = 0, updated = 0, skipped = 0;

      for(let r=start; r<rows.length; r++){
        const row = rows[r];
        if(!row || row.length === 0) continue;

        const s = trim(row[idxSku] ?? '');
        const n = trim(row[idxName] ?? '');
        if(!s){ skipped++; continue; }

        const rawH = row[idxHsd];
        const h = normalizeDateToISO(rawH ?? '');

        // 2 c·ªôt (SKU, NAME) => ch·ªâ map danh m·ª•c
        if(!rawH || !trim(rawH) || !validISODate(h)){
          const finalName = n || skuMap[s] || 'S·∫£n ph·∫©m m·ªõi';
          if(!skuMap[s] || (n && n !== skuMap[s])) {
            skuMap[s] = finalName;
            mapAdded++;
          }
          continue;
        }

        // 3 c·ªôt (SKU, NAME, HSD)
        const finalName = n || skuMap[s] || 'S·∫£n ph·∫©m m·ªõi';
        if(!skuMap[s] || (finalName && finalName !== 'S·∫£n ph·∫©m m·ªõi')) skuMap[s] = finalName;

        const exist = data.find(x => x.sku === s && x.hsd === h);
        if(exist){
          exist.name = skuMap[s] || finalName;
          updated++;
        }else{
          data.push({ id: uid(), sku:s, name: skuMap[s] || finalName, hsd:h, createdAt: now() });
          added++;
        }
      }

      saveStorage();
      render();
      showToast(`‚úÖ Import: Danh m·ª•c +${mapAdded}, HSD +${added}, c·∫≠p nh·∫≠t ${updated}, b·ªè qua ${skipped}`);
      vibrate(12);
    }catch(e){
      showToast('‚ùå Import l·ªói');
      vibrate(25);
    }
  }

  function exportCSV(){
    try{
      const out = [...data].sort((a,b) => a.hsd.localeCompare(b.hsd));
      let csv = '\uFEFF' + ['sku','name','hsd'].join(',') + '\n';
      out.forEach(it => {
        csv += [toCSVCell(it.sku), toCSVCell(it.name), toCSVCell(it.hsd)].join(',') + '\n';
      });

      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'kiem_date.csv';
      a.rel = 'noopener';
      a.click();
      setTimeout(() => URL.revokeObjectURL(url), 1500);

      showToast('üì§ ƒê√£ xu·∫•t CSV');
      vibrate(10);
    }catch(e){
      showToast('‚ùå Kh√¥ng xu·∫•t ƒë∆∞·ª£c');
      vibrate(25);
    }
  }

  // ========= Clipboard =========
  async function smartPaste(){
    try{
      const t = await navigator.clipboard.readText();
      if(!t){ showToast('‚ö†Ô∏è Clipboard tr·ªëng'); vibrate(25); return; }
      skuI.value = trim(t);
      updateSuggestions();
      hsdI.focus();
      showToast('üìã ƒê√£ d√°n SKU');
      vibrate(10);
    }catch(e){
      showToast('‚ö†Ô∏è Clipboard b·ªã ch·∫∑n');
      vibrate(25);
    }
  }

  // ========= Events =========
  skuI.addEventListener('input', updateSuggestions);
  searchI.addEventListener('input', render);

  btnPaste.addEventListener('click', smartPaste);
  btnSave.addEventListener('click', upsert);

  btnCancelEdit.addEventListener('click', () => { exitEdit(); showToast('‚Ü©Ô∏è ƒê√£ hu·ª∑ s·ª≠a'); });
  btnDeleteEdit.addEventListener('click', async () => { if(editingId) await deleteById(editingId); });

  btnImport.addEventListener('click', () => csvIn.click());
  csvIn.addEventListener('change', async () => {
    const f = csvIn.files && csvIn.files[0];
    if(!f) return;
    await importCSV(f);
    csvIn.value = '';
  });

  btnExport.addEventListener('click', exportCSV);

  btnClearAll.addEventListener('click', async () => {
    const ok = await openConfirm({
      title:'Xo√° to√†n b·ªô?',
      text:'B·∫°n mu·ªën xo√° t·∫•t c·∫£ d·ªØ li·ªáu trong m√°y? (Kh√¥ng kh√¥i ph·ª•c ƒë∆∞·ª£c)',
      okText:'Xo√° ALL',
      cancelText:'Hu·ª∑'
    });
    if(!ok) return;

    data = [];
    skuMap = {};
    editingId = null;

    saveStorage();
    render();
    exitEdit();
    showToast('üßπ ƒê√£ xo√° to√†n b·ªô');
    vibrate(15);
  });

  // ========= Init =========
  if(!storageAvailable()){
    showToast('‚ö†Ô∏è localStorage b·ªã ch·∫∑n (m·ªü Safari/Chrome th·∫≠t, kh√¥ng ·∫©n danh/webview)', 2400);
  }
  loadStorage();
  render();
  showToast('‚úÖ S·∫µn s√†ng', 900);
})();
</script>
</body>
</html>