<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<title>Ki·ªÉm Date</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" sizes="180x180" href="icon-180.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Ki·ªÉm Date">
<meta name="theme-color" content="#1565c0">

<style>
body{
  font-family:-apple-system,BlinkMacSystemFont,Arial;
  background:#f2f6fb;
  margin:0;
  padding:14px;
}
.app{
  background:#fff;
  border-radius:18px;
  padding:16px;
  box-shadow:0 10px 24px rgba(0,0,0,.08);
}
h2{
  text-align:center;
  margin:0 0 14px;
  color:#1565c0;
}
label{
  font-size:14px;
  color:#333;
}
input{
  width:100%;
  height:40px;
  font-size:16px;
  margin:6px 0 12px;
  padding:0 10px;
  border-radius:10px;
  border:1.5px solid #cfd8dc;
}
button{
  width:100%;
  height:44px;
  border:none;
  border-radius:12px;
  background:#1565c0;
  color:#fff;
  font-size:16px;
  margin-bottom:10px;
}
.list{
  margin-top:18px;
}
.item{
  padding:10px 0;
  border-bottom:1px dashed #e0e0e0;
}
.expire-soon{color:#ef6c00;}
.expired{color:#c62828;}
.small{font-size:13px;color:#666}
</style>
</head>

<body>
<div class="app">
<h2>üóìÔ∏è KI·ªÇM DATE</h2>

<label>T√™n s·∫£n ph·∫©m</label>
<input id="name" placeholder="VD: S·ªØa t∆∞∆°i">

<label>M√£ / SKU</label>
<input id="sku" placeholder="Qu√©t ho·∫∑c nh·∫≠p m√£">
<button style="background:#2e7d32" onclick="startScan()">üì∑ Qu√©t QR</button>

<label>Ng√†y h·∫øt h·∫°n</label>
<input type="date" id="expire">

<button onclick="saveItem()">‚ûï L∆∞u s·∫£n ph·∫©m</button>

<div id="qrBox" style="display:none;margin-top:10px">
  <div id="reader" style="width:100%"></div>
  <button style="background:#c62828" onclick="stopScan()">‚úñ ƒê√≥ng camera</button>
</div>

<div class="list" id="list"></div>
</div>

<!-- QR library -->
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
let db, qr;

// ===== IndexedDB =====
function openDB(){
  return new Promise((res,rej)=>{
    const req = indexedDB.open('kiem-date-db',1);
    req.onupgradeneeded = e=>{
      db = e.target.result;
      const store = db.createObjectStore('items',{keyPath:'id',autoIncrement:true});
      store.createIndex('expire','expire');
    };
    req.onsuccess = e=>{ db=e.target.result; res(); };
    req.onerror = ()=>rej();
  });
}

function saveItem(){
  const nameEl = document.getElementById('name');
  const skuEl = document.getElementById('sku');
  const expEl = document.getElementById('expire');

  if(!nameEl.value || !expEl.value){
    alert('Nh·∫≠p t√™n v√† ng√†y h·∫øt h·∫°n');
    return;
  }

  const tx = db.transaction('items','readwrite');
  tx.objectStore('items').add({
    name: nameEl.value.trim(),
    sku: skuEl.value.trim(),
    expire: expEl.value,
    created: new Date().toISOString()
  });

  nameEl.value = skuEl.value = expEl.value = '';
  setTimeout(loadItems,200);
}

function loadItems(){
  const tx = db.transaction('items','readonly');
  const req = tx.objectStore('items').getAll();
  req.onsuccess = ()=>{
    const now = new Date();
    list.innerHTML='';
    req.result.forEach(it=>{
      const d = new Date(it.expire);
      const diff = Math.ceil((d-now)/86400000);
      let cls='', txt=`C√≤n ${diff} ng√†y`;
      if(diff<0){cls='expired';txt='ƒê√£ h·∫øt h·∫°n';}
      else if(diff<=7){cls='expire-soon';}

      list.innerHTML+=`
        <div class="item ${cls}">
          <b>${it.name}</b><br>
          <span class="small">HSD: ${it.expire} ‚Äì ${txt}</span>
        </div>`;
    });
  };
}

// ===== QR Scan =====
function startScan(){
  document.getElementById('qrBox').style.display='block';
  qr = new Html5Qrcode("reader");
  qr.start(
    { facingMode:"environment" },
    { fps:10, qrbox:250 },
    txt=>{
      document.getElementById('sku').value = txt;
      stopScan();
    }
  );
}

function stopScan(){
  if(qr){
    qr.stop().then(()=>qr.clear());
  }
  document.getElementById('qrBox').style.display='none';
}

// init
openDB().then(loadItems);
</script>
</body>
</html>
