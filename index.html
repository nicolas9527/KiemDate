<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="KIá»‚M DATE">

<link rel="apple-touch-icon" href="icon.png">
<link rel="manifest" href="manifest.json">
<title>KIá»‚M DATE</title>

<style>
body{margin:0;font-family:-apple-system,Arial;background:#eaf4e6;padding:14px;color:#333}
.app{background:#f4faee;border-radius:22px;padding:20px;max-width:500px;margin:auto}
h1{text-align:center;color:#2e7d32;font-size:24px;font-weight:800}

.input-group{margin-bottom:16px;position:relative}
label{color:#2e7d32;font-weight:700;font-size:14px;margin-bottom:6px;display:block}
input{width:100%;height:50px;border-radius:12px;border:2px solid #a5d6a7;padding:0 12px;font-size:16px}

.suggestions{
position:absolute;top:74px;left:0;right:0;
background:#fff;border-radius:12px;border:1px solid #a5d6a7;
box-shadow:0 10px 25px rgba(0,0,0,.1);display:none;z-index:10
}
.suggestion-item{padding:12px;border-bottom:1px solid #eee;cursor:pointer}
.suggestion-item:last-child{border-bottom:none}
.suggestion-item b{color:#1b5e20}
.suggestion-item small{color:#666}

.btns{display:flex;gap:10px}
.main-btn{flex:1;height:50px;border:none;border-radius:12px;font-weight:700;color:#fff}
.paste{background:#81c784}
.save{background:linear-gradient(#43a047,#2e7d32)}

.tools-container{display:flex;justify-content:space-between;align-items:center;margin:20px 0}
.import-btn{background:#fff;border:1px solid #2e7d32;color:#2e7d32;padding:8px 12px;border-radius:10px;font-weight:700}
#sortSelect{padding:8px 12px;border-radius:10px;border:1px solid #a5d6a7}

.item{background:#fff;border-radius:15px;padding:15px;margin-bottom:12px;border-left:6px solid #a5d6a7;position:relative;padding-right:50px}
.warn30{border-left-color:#fbc02d}
.warn7{border-left-color:#c62828}

.p-name{font-weight:700;color:#1b5e20;font-size:17px}
.p-sku{font-family:monospace;font-size:12px;background:#f0f0f0;padding:2px 6px;border-radius:4px}
.w30{color:#f9a825;font-weight:700}
.w7{color:#c62828;font-weight:700}
.expired{color:#b71c1c;font-weight:900}

.icon-btn{position:absolute;right:10px;width:34px;height:34px;border:none;border-radius:10px}
.del-btn{top:12px;background:#ffeeee;color:#d32f2f;font-size:18px}
.copy-btn{bottom:12px;background:#e8f5e9;color:#2e7d32}
</style>
</head>

<body>
<div class="app">
<h1>ðŸ“… KIá»‚M DATE</h1>

<div class="input-group">
<label>MÃ£ SKU</label>
<input id="sku" placeholder="Nháº­p hoáº·c dÃ¡n mÃ£">
<div id="suggestions" class="suggestions"></div>
</div>

<div class="input-group">
<label>TÃªn sáº£n pháº©m</label>
<input id="name" placeholder="TÃªn tá»± hiá»‡n náº¿u Ä‘Ã£ lÆ°u">
</div>

<div class="input-group">
<label>Háº¡n sá»­ dá»¥ng</label>
<input id="hsd" type="date">
</div>

<div class="btns">
<button class="main-btn paste" onclick="smartPaste()">ðŸ“‹ DÃ¡n mÃ£</button>
<button class="main-btn save" onclick="save()">ðŸ’¾ LÆ°u láº¡i</button>
</div>

<div class="tools-container">
<input type="file" id="csvFile" accept=".csv,.txt" hidden onchange="handleFile(this)">
<button class="import-btn" onclick="csvFile.click()">ðŸ“¥ Nháº­p File</button>

<select id="sortSelect" onchange="render()">
<option value="date-asc">Háº¡n dÃ¹ng (Gáº§n â†’ Xa)</option>
<option value="date-desc">Háº¡n dÃ¹ng (Xa â†’ Gáº§n)</option>
<option value="name-asc">TÃªn (A â†’ Z)</option>
<option value="name-desc">TÃªn (Z â†’ A)</option>
</select>
</div>

<div class="input-group">
<input id="search" placeholder="ðŸ” TÃ¬m theo tÃªn hoáº·c SKU" oninput="render()">
</div>

<div id="list"></div>
</div>

<script>
if('serviceWorker'in navigator){navigator.serviceWorker.register('sw.js').catch(()=>{})}

let data=JSON.parse(localStorage.getItem('dates')||'[]')
let skuMap=JSON.parse(localStorage.getItem('skuMap')||'{}')

const skuInput=sku,nameInput=name,hsdInput=hsd,sug=suggestions

/* ===== CSV IMPORT (FIX BOM) ===== */
function handleFile(input){
const file=input.files[0];if(!file)return
const reader=new FileReader()
reader.onload=e=>{
e.target.result.split(/\r?\n/).forEach(l=>{
const p=l.split(/,|;/)
if(p.length>=2){
const sku=String(p[0]).replace(/\ufeff/g,'').trim()
const name=String(p[1]).trim()
if(sku&&name&&sku.toLowerCase()!=='sku')skuMap[sku]=name
}})
localStorage.setItem('skuMap',JSON.stringify(skuMap))
alert("âœ… Nháº­p file thÃ nh cÃ´ng")
input.value=''
}
reader.readAsText(file)
}

/* ===== SKU SUGGEST ===== */
skuInput.oninput=()=>{
const v=skuInput.value.trim().toLowerCase()
sug.innerHTML=''
if(v.length>=3){
Object.keys(skuMap).filter(k=>k.toLowerCase().includes(v)).forEach(k=>{
const d=document.createElement('div')
d.className='suggestion-item'
d.innerHTML=`<b>${k}</b><br><small>${skuMap[k]}</small>`
d.onclick=()=>{skuInput.value=k;nameInput.value=skuMap[k];sug.style.display='none';hsdInput.focus()}
sug.appendChild(d)
})
sug.style.display=sug.children.length?'block':'none'
}else sug.style.display='none'
if(skuMap[skuInput.value])nameInput.value=skuMap[skuInput.value]
}

document.addEventListener('click',e=>{if(e.target!==skuInput)sug.style.display='none'})

async function smartPaste(){
try{
const t=(await navigator.clipboard.readText()).trim()
skuInput.value=t
if(skuMap[t])nameInput.value=skuMap[t]
hsdInput.focus()
}catch{}
}

/* ===== SAVE (ANTI DUPLICATE) ===== */
function save(){
if(!skuInput.value||!hsdInput.value)return alert("âš ï¸ Thiáº¿u thÃ´ng tin!")
const sku=skuInput.value.trim(),name=(nameInput.value||'Sáº£n pháº©m má»›i').trim(),hsd=hsdInput.value
if(data.find(i=>i.sku===sku&&i.hsd===hsd))return alert("âš ï¸ ÄÃ£ tá»“n táº¡i!")
skuMap[sku]=name
data.push({sku,name,hsd})
localStorage.setItem('dates',JSON.stringify(data))
localStorage.setItem('skuMap',JSON.stringify(skuMap))
skuInput.value=nameInput.value=hsdInput.value=''
render()
}

function del(i){if(confirm("XÃ³a má»¥c nÃ y?")){data.splice(i,1);localStorage.setItem('dates',JSON.stringify(data));render()}}
function copy(t,b){navigator.clipboard.writeText(t);b.innerHTML='âœ”';setTimeout(()=>b.innerHTML='ðŸ“‹',800)}

/* ===== RENDER (SEARCH + TODAY FIX) ===== */
function render(){
const list=document.getElementById('list')
list.innerHTML=''
const key=document.getElementById('search').value.toLowerCase()
const sort=document.getElementById('sortSelect').value

data.sort((a,b)=>{
if(sort.includes('date'))return sort==='date-asc'?new Date(a.hsd)-new Date(b.hsd):new Date(b.hsd)-new Date(a.hsd)
return sort==='name-asc'?a.name.localeCompare(b.name,'vi'):b.name.localeCompare(a.name,'vi')
})

data.filter(i=>i.name.toLowerCase().includes(key)||i.sku.toLowerCase().includes(key))
.forEach((i,idx)=>{
const d=Math.ceil((new Date(i.hsd+'T23:59:59')-Date.now())/86400000)
let cls='',txt='',tc=''
if(d<0){cls='warn7';txt='Háº¾T Háº N';tc='expired'}
else if(d===0){cls='warn7';txt='âš ï¸ Háº¾T Háº N HÃ”M NAY';tc='w7'}
else if(d<=7){cls='warn7';txt=`âš ï¸ CÃ²n ${d} ngÃ y`;tc='w7'}
else if(d<=30){cls='warn30';txt=`â° CÃ²n ${d} ngÃ y`;tc='w30'}
else txt=`CÃ²n ${d} ngÃ y`

list.innerHTML+=`
<div class="item ${cls}">
<div class="p-name">${i.name}</div>
<div><span class="p-sku">${i.sku}</span></div>
<div>HSD: <b>${i.hsd.split('-').reverse().join('/')}</b></div>
<div class="${tc}" style="margin-top:6px">${txt}</div>
<button class="icon-btn del-btn" onclick="del(${idx})">Ã—</button>
<button class="icon-btn copy-btn" onclick="copy('${i.sku}',this)">ðŸ“‹</button>
</div>`
})
}
render()
</script>
</body>
</html>
